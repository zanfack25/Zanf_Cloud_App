<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Ball Clicking Game</title>

<link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

<!-- THREE.JS CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>

<!-- GSAP (for optional animations) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
  body { background:#121212; color:white; text-align:center; font-family:Roboto; margin:0; padding:0; }
  #game-container {
    width:100%; height:500px; margin-top:10px;
  }
  #stats {
    display:none; margin-top:20px; padding:20px;
  }
</style>
</head>
<body>

<h2>3D Ball Challenge</h2>
<h3>Good luck, {{ username }}!</h3>

<!-- Background Sound -->
<audio id="bg-sound" loop autoplay>
  <source src="https://cdn.pixabay.com/audio/2021/08/04/audio_619b701a65.mp3" type="audio/mp3">
</audio>

<div id="game-container"></div>

<div id="stats" class="mdc-card mdc-elevation--z4" style="color:black;">
  <h2>Game Results</h2>
  <p><strong>Total Balls:</strong> <span id="total-balls"></span></p>
  <p><strong>Total Points:</strong> <span id="total-points"></span></p>
  <p><strong>Final Score:</strong> <span id="final-score"></span></p>
  <h3 id="medal"></h3>
</div>

<script>
const container = document.getElementById("game-container");
let scene, camera, renderer, raycaster, mouse;
let spheres = [];
const totalBalls = 20;
let launched = 0;
let points = 0;

init3D();
launchSphere();

function init3D() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color("#121212");

  camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 1000);
  camera.position.set(0, 0, 40);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  const light = new THREE.PointLight(0xffffff, 1.5);
  light.position.set(10, 20, 10);
  scene.add(light);

  const ambient = new THREE.AmbientLight(0xffffff, 0.4);
  scene.add(ambient);

  raycaster = new THREE.Raycaster();
  mouse = new THREE.Vector2();

  renderer.domElement.addEventListener("click", onClick);
  animate();
}

function createBall() {
  const score = Math.floor(Math.random()*9 + 1);
  const geometry = new THREE.SphereGeometry(1.5, 32, 32);

  const material = new THREE.MeshStandardMaterial({
    color: new THREE.Color(`hsl(${Math.random()*360}, 100%, 50%)`),
    roughness: 0.2,
    metalness: 0.8
  });

  const ball = new THREE.Mesh(geometry, material);

  // Random start position
  ball.position.x = (Math.random()*20 - 10);
  ball.position.y = (Math.random()*14 - 7);
  ball.position.z = 0;

  ball.userData.score = score;

  scene.add(ball);

  // Optional bounce animation
  gsap.from(ball.scale, {
    x:0.01, y:0.01, z:0.01,
    duration:0.4,
    ease:"back.out(2)"
  });

  spheres.push(ball);

  // Remove after delay if not clicked
  setTimeout(() => {
    if (scene.children.includes(ball)) {
      scene.remove(ball);
      spheres = spheres.filter(b => b !== ball);
    }
  }, 1200);
}

function launchSphere() {
  if (launched >= totalBalls) return endGame();

  launched++;
  createBall();

  setTimeout(launchSphere, 700);
}

function onClick(event) {
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((event.clientX - rect.left) / rect.width ) * 2 - 1;
  mouse.y = -((event.clientY - rect.top) / rect.height ) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(spheres);

  if (intersects.length > 0) {
    const hit = intersects[0].object;

    points += hit.userData.score;

    gsap.to(hit.scale, {
      x:0, y:0, z:0, duration:0.2, onComplete:() => {
        scene.remove(hit);
        spheres = spheres.filter(b => b !== hit);
      }
    });
  }
}

function endGame() {
  document.getElementById("total-balls").textContent = launched;
  document.getElementById("total-points").textContent = points;
  document.getElementById("final-score").textContent = points;

  let medal = "No Medal";
  if (points >= 120) medal = "ðŸ¥‡ Gold Medal";
  else if (points >= 90) medal = "ðŸ¥ˆ Silver Medal";
  else if (points >= 60) medal = "ðŸ¥‰ Bronze Medal";

  document.getElementById("medal").textContent = medal;

  document.getElementById("stats").style.display = "block";
}

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
</script>

</body>
</html>
